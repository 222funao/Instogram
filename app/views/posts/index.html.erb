<main>
<div class="feed">
  <% if @posts.empty? %>
  <% if params[:query].present? %>
    <div class="no-results">
      No hay resultados para "<strong><%= params[:query] %></strong>"
    </div>
  <% else %>
    <div class="no-results">
      AÃºn no hay publicaciones
    </div>
  <% end %>
<% end %>

  <% @posts.each do |post| %>
    <div class="post-card">
      <div class="post-header">
        <div class="post-user">
    <% if current_user.avatar.attached? %>
          <%= image_tag current_user.avatar, class: "avatar" %>
        <% else %>
          <%= image_tag "default_avatar.png", class:"avatar" %>

        
  <% end %>

  <strong>@<%= post.user.username %></strong>
</div>

      </div>
      
<% if post.media.attached? %>
  <div class="carousel" data-carousel>

    <% if post.media.count > 1 %>
      <button class="carousel-btn prev" type="button">â€¹</button>
    <% end %>

    <div class="carousel-track">
      <% post.media.each do |file| %>
        <div class="carousel-item">

          <div class="post-media-frame">
            <% if file.image? %>
              <%= image_tag file, class: "post-media" %>

         <% elsif file.video? %>
  <div class="video-wrapper post-media">
    <video
      class="post-media post-video"
      muted
      loop
      playsinline
      preload="metadata"
      data-video
    >
      <source src="<%= url_for(file) %>" type="<%= file.content_type %>">
    </video>

    <button class="mute-btn" type="button">ðŸ”‡</button>
  </div>
<% end %>
          </div>

        </div>
      <% end %>
    </div>

    <% if post.media.count > 1 %>
      <button class="carousel-btn next" type="button">â€º</button>
    <% end %>

    <% if post.media.count > 1 %>
      <div class="carousel-dots">
        <% post.media.each_with_index do |_, index| %>
          <span
            class="dot <%= 'active' if index == 0 %>"
            data-index="<%= index %>">
          </span>
        <% end %>
      </div>
    <% end %>

  </div>
<% end %>






<div class="like-section">
<div id="post_<%= post.id %>_like">
  <%= render "likes/button", post: post %>
</div>







 
</div>

<% if post.caption.present? %>
  <div class="post-body">
    <div class="post-user-caption">
      
      <div class="avatar-container">
        <% if post.user.avatar.attached? %>
          <%= image_tag post.user.avatar, class: "avatar" %>
        <% else %>
          <%= image_tag "default_avatar.png", class: "avatar" %>
        <% end %>
      </div>

      <div class="post-caption-content">
        <strong class="username-text">@<%= post.user.username %></strong><span class="caption-text"><%= post.caption %></span>
      </div>

    </div>
  </div>
<% end %>

<div class="comments-section">
  <button class="toggle-comments-btn">
    Ver comentarios
  </button>
  <div class="comments-box hidden">
    <div id="comments_<%= post.id %>" class="comments">
  <%= render post.comments %>
</div>

   <div class="comment-form">
  <%= render "comments/form", post: post %>
</div>

  </div>

</div>



    </div>
  <% end %>


</div>

<button id="toggle-sidebar" class="messages-btn">
  ðŸ’¬ Mensajes
</button>


</div>
</main>

<script>
 // Definimos la funciÃ³n fuera para que sea una referencia estable
// 1. Forzar Modo Oscuro Siempre (Incluso antes de que cargue el body)


// 2. FunciÃ³n de Toggle
const globalSidebarToggle = (e) => {
    const btn = e.target.closest("#toggle-sidebar");
    if (btn) {
        const sidebar = document.getElementById("sidebar");
        if (sidebar) {
            sidebar.classList.toggle("active");
        }
    }
};

// 3. Vincular al objeto WINDOW (MÃ¡xima jerarquÃ­a)
// Esto sobrevive a cambios de HTML, Turbo y navegaciÃ³n hacia atrÃ¡s
if (!window.sidebarInitialized) {
    window.addEventListener("click", globalSidebarToggle);
    window.sidebarInitialized = true;
}


</script>
